@page "/formations/{id}"

@inject HttpClient Client
@inject IJSRuntime JsRuntime
@* @inject MediwatchPanier Panier *@

@inject Blazored.LocalStorage.ILocalStorageService Storage

@if (_formation == null)
{
    @if (!_erreur)
    {
        <p>En attente d'acquisition des informations de la formation...</p>
        <div class="loading-bar"></div>
    }
    else
    {
        <p>Formation inexistante, <a href="/">retourner à la page d'accueil ?</a></p>
    }

}
else
{
    <FormationItemView f=_formation></FormationItemView>


    @if (_info == null || !_info.IsAuthenticated)
    {
        <button class="btn btn-primary" @onclick="@Registration" disabled>
            S'inscrire à la formation
        </button>
        <button class="btn btn-primary" @onclick="@Ajout" disabled>
            Ajouter la formation à mon panier
        </button>
    }
    else
    {
        <button class="btn btn-primary" @onclick="@Registration">
            S'inscrire à la formation
        </button>
        <button class="btn btn-primary" @onclick="@Ajout">
            Ajouter la formation à mon panier
        </button>
    }

    <hr />

    <ArticleViewer articleName=@_formation.ArticleID></ArticleViewer>

    <div id="notif" style="border-style: dashed; visibility: @visibility">
        <p>Formation ajoutée correctement au panier.</p>
        <button class="btn btn-secondary" @onclick="@Redirection">Voir mon panier</button>
        <Button class="btn btn-secondary" @onclick="@Disparition">Réduire</Button>
    </div>
}

@code {
    [Parameter]
    public String Id { get; set; }

    private formation _formation = null;

    private UserInformation _info = null;

    private bool _erreur = false;


    private string visibility = "hidden";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _info = await Client.GetFromJsonAsync<UserInformation>("Account/UserInfo");
            _formation = await Client.GetFromJsonAsync<formation>("Formation/" + Id);
        }
        catch
        {
            _erreur = true;
        }
    }

    private async Task Registration()
    {
        Console.WriteLine("Inscription à la formation en elle-même, passer par Paypal directement ?");
        // Enregistrer ici l'utilisateur à la formation !
        //JSRuntime.InvokeVoidAsync("display", e);
    }

    private async void Ajout()
    {
        Console.WriteLine(("ajout !"));

        var formations = await Storage.GetItemAsync<List<string>>("formations");

        if (formations == null)
        {
            formations = new List<string>();
        }

        if (formations.Contains(Id))
        {
            Console.WriteLine("Impossible d'ajouter la formation, déjà présente.");
            return;
        }

        Console.WriteLine(formations);
        Console.WriteLine(formations.Count);

        formations.Add(Id);

        Console.WriteLine(formations);
        Console.WriteLine(formations.Count);

        await Storage.SetItemAsync<List<string>>("formations", formations);

        visibility = "visible";

        StateHasChanged();
    }

    private void Redirection()
    {
        JsRuntime.InvokeAsync<object>("open", "/utilisateur/achat", "_blank");
    }

    private void Disparition()
    {
        visibility = "hidden";
        StateHasChanged();
    }
}